{% extends "layout/layout.html" %}
{% load static %} {# THÊM DÒNG NÀY #}

{% block css %}
<link rel="stylesheet" href="{% static 'css/display_location.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    #map {
        height: 500px;
        width: 100%;
    }
</style>
<link rel="stylesheet" href="{% static 'css/display_location.css' %}?v={{ timestamp }}">
{% endblock %}

{% block title %} {{location_name}} {% endblock %}

{% block body %}
<div class="location-container">
    <div class="location-name">
        {{ location_name }}
    </div>

    <div class="location-rating">
        <strong>Rating:</strong>{{ star_html|safe }}
    </div>

    <div class="location-address">
        <strong>Address:</strong>{{ address }}
    </div>

    <div class="image-block">
        <div class="location-img">
            <img src="{% static image_path %}" alt="{{ location.name }}">
        </div>
    </div>

    <div class="time-block">
        <strong>Open hour:</strong>{{ open_time }} 
    </div>

    <div class="location-ticket-info">
        <strong>Price:</strong>{{ ticket_info }}
    </div>

    <div class="location-description">
        <strong>Description:</strong>{{ long_description }}
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js">
    </script>

    <script>
        // Set your coordinates here
        const latitude = {{ lat }};
        const longitude = {{ long }};

        const map = L.map('map').setView([latitude, longitude], 40);

        // Load and display tile layer from OSM
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Add a marker
        L.marker([latitude, longitude]).addTo(map)
            .bindPopup('{{ location_name }}')
            .openPopup();

        document.querySelectorAll('.fav-btn').forEach(function (button) {
            button.addEventListener('click', function (e) {
                e.preventDefault(); // Ngăn chuyển trang
                const code = this.dataset.code;
                const icon = this.querySelector('i');

                fetch("{% url 'locations' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: `value=${code}`
                })
                    .then(response => {
                        if (response.ok) {
                            // Đổi icon khi thành công
                            if (icon.classList.contains('fa-regular')) {
                                icon.classList.remove('fa-regular');
                                icon.classList.add('fa-solid');
                            } else {
                                icon.classList.remove('fa-solid');
                                icon.classList.add('fa-regular');
                            }
                        } else {
                            alert("Có lỗi xảy ra khi cập nhật favourite.");
                        }
                    });
            });
        });
    </script>

    <div class="favourite-block">
        <div class="favourite-location">
            <form method="post" action="{% url 'locations' %}" class="fav-form" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="value" value="{{ code }}">
                <button type="submit" style="background: none; border: none; padding: 0; cursor: pointer;">
                    {{ favourite_symbol|safe }}
                </button>
            </form>
        </div>
    </div>
</div>

{% endblock %}