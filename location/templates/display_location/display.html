{% extends "layout/layout.html" %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/display_location.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    #map {
        height: 500px;
        width: 100%;
    }

    .comment-box, .reply-box {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
    }

    .reply-box {
        background-color: #f0f0f0;
    }

    textarea {
        width: 100%;
        resize: vertical;
    }

    input[type="submit"] {
        background-color: #4CAF50;
        color: white;
        padding: 6px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    input[type="submit"]:hover {
        background-color: #45a049;
    }
</style>
<link rel="stylesheet" href="{% static 'css/display_location.css' %}?v={{ timestamp }}">
{% endblock %}

{% block title %} {{location_name}} {% endblock %}

{% block body %}
<div class="location-container">
    <div class="location-name">
        {{ location_name }}
    </div>

    <div class="location-rating">
        <strong>Rating:</strong> {{ star_html|safe }}
    </div>

    <div class="location-address">
        <strong>Address:</strong>{{ address }}
    </div>

    <div class="image-block">
        <div class="location-img">
            <img src="{% static image_path %}" alt="{{ location.name }}">
        </div>
    </div>

    <div class="time-block">
        <strong>Open hour: </strong> {{ open_time }} 
    </div>

    <div class="location-ticket-info">
        <strong>Price:</strong>{{ ticket_info }}
    </div>

    <div class="location-description">
        <strong>Description:</strong>{{ long_description }}
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js">
    </script>

    <script>
        const latitude = {{ lat }};
        const longitude = {{ long }};

        const map = L.map('map').setView([latitude, longitude], 40);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        L.marker([latitude, longitude]).addTo(map)
            .bindPopup('{{ location_name }}')
            .openPopup();

        document.querySelectorAll('.fav-btn').forEach(function (button) {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const code = this.dataset.code;
                const icon = this.querySelector('i');

                fetch("{% url 'locations' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: `value=${code}`
                })
                    .then(response => {
                        if (response.ok) {
                            if (icon.classList.contains('fa-regular')) {
                                icon.classList.remove('fa-regular');
                                icon.classList.add('fa-solid');
                            } else {
                                icon.classList.remove('fa-solid');
                                icon.classList.add('fa-regular');
                            }
                        } else {
                            alert("CÃ³ lá»—i xáº£y ra khi cáº­p nháº­t favourite.");
                        }
                    });
            });
        });
    </script>

    <div class="favourite-block">
        <div class="favourite-location">
            <form method="post" action="{% url 'locations' %}" class="fav-form" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="value" value="{{ code }}">
                <button type="submit" style="background: none; border: none; padding: 0; cursor: pointer;">
                    {{ favourite_symbol|safe }}
                </button>
            </form>
        </div>
    </div>

    <!-- ðŸ”½ Comment Section Start -->
    {% for comment in comments %}
        <div class="comment">
            <p><strong>{{ comment.user.username }}</strong>: {{ comment.content }}</p>
            <p><em>Bot reply:</em> {{ comment.bot_reply }}</p>

            <!-- Displaying replies if they exist -->
            {% if comment.replies.all %}
                <div class="replies">
                    {% for reply in comment.replies.all %}
                        <div class="reply">
                            <p><strong>{{ reply.user.username }}</strong>: {{ reply.content }}</p>
                            <p><em>Bot reply:</em> {{ reply.bot_reply }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    {% endfor %}

    <!-- Comment Form -->
    <h3>Post a comment</h3>
    <form method="post" action="{% url 'display_location' code %}">
        {% csrf_token %}
        <textarea name="content" placeholder="Write your comment..." required></textarea>
        <button type="submit">Submit Comment</button>
    </form>

</div>
{% endblock %}
